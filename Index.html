<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>B-Spline</title>

    <link href="./wwwroot/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="./wwwroot/lib/jquery/dist/jquery.min.js"></script>

</head>

<body>

    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"
                    aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">B Spline Calculations</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav"></ul>

                <ul class="nav navbar-nav navbar-right"></ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <div class="container-fluid">

        <div class="row">

            <div class="col-md-12" id="controlPanel">

                <div class="panel panel-primary">

                    <div class="panel-heading">
                        <h4>
                            Control Panel
                        </h4>
                    </div>

                    <div class="panel-body">

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="">
                                        Spline
                                    </label>
                                    <select class="form-control" data-bind="value:spline">
                                        <option selected value="1">B-Spline</option>
                                        <option value="2">Bezier</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row" id="bspline-control-panel">

                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="">
                                        Order
                                    </label>
                                    <select class="form-control" data-bind="value:order">
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="">
                                        Fitting Mode
                                    </label>
                                    <select class="form-control" data-bind="value:fittingMode">
                                        <option value="1">Using Control Points</option>
                                        <option value="2">Approximation</option>
                                        <option value="3">Interpolation</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-3" data-bind="visible:spline()==1 && fittingMode()==2 || fittingMode()==3">
                                <div class="form-group">
                                    <label class="">
                                        Parameter Selection
                                    </label>
                                    <select class="form-control" data-bind="value:parameterSelection">
                                        <option value="uniformly-spaced">Uniformly Spaced</option>
                                        <option value="chord-length">Chord Length</option>
                                        <option value="centripetal">Centripetal</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-3" data-bind="visible:spline()==1 && fittingMode()==2 || fittingMode()==3">
                                <div class="form-group">
                                    <label class="">
                                        Knot Selection
                                    </label>
                                    <select class="form-control" data-bind="visible:spline()==1 && fittingMode()==2 || fittingMode()==3,value:knotSelection">
                                        <option value="uniformly-spaced">Uniformly Spaced</option>
                                        <option value="deboor-average">Deboor Average</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-3" data-bind="visible:spline()==1 && fittingMode()==2">
                                <div class="form-group">
                                    <label class="">
                                        Number Of Control Points
                                    </label>
                                    <input data-bind="value:numberOfControlPoints" type="number" class="form-control" value="" />
                                </div>
                            </div>

                            <div class="col-md-3" data-bind="visible:spline()==1 && fittingMode()==2">
                                <div class="form-group">
                                    <label class="">
                                        Error Limit (avg)
                                    </label>
                                    <input data-bind="value:errorLimit" type="number" class="form-control" value="" />
                                </div>
                            </div>

                             <div class="col-md-3" data-bind="visible:spline()==1 && fittingMode()==2">
                                 <div class="form-group">
                                    <label class="">
                                        Noise Reduction
                                    </label>
                                    <select class="form-control" data-bind="value:noiseReductionAlgorithm">
                                        <option value="0">Do Not Remove Any Noise</option>
                                        <option value="1">Use Douglas-Peucker</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-3" data-bind="visible:fittingMode()==2 && noiseReductionAlgorithm()==1">
                                <div class="form-group">
                                    <label class="">
                                        Tolerance
                                    </label>
                                    <input data-bind="value:tolerance" type="number" class="form-control" value="" />
                                </div>
                            </div>

                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="">
                                        File
                                    </label>
                                    <input id="file" data-bind="value:file" class="form-control" type="file" value="" />
                                </div>
                            </div>
                        </div>

                        <hr />

                        <button class="btn btn-success" data-bind="click:plot">
                            Plot!
                        </button>

                    </div>
                </div>

            </div>

            <div class="col-md-12" id="resultPanel">

                <div class="panel panel-success">

                    <div class="panel-heading">
                        <h4>Result Panel</h4>
                    </div>

                    <div class="panel-body">

                        <div class="row">

                            <div class="col-md-3">
                                <label>Min Distance:</label>
                                <span data-bind="text:minDistance"> </span>
                            </div>

                            <div class="col-md-3">
                                <label>Max Distance:</label>
                                <span data-bind="text:maxDistance"></span>
                            </div>

                            <div class="col-md-3">
                                <label>Avg Distance:</label>
                                <span data-bind="text:avgDistance"></span>
                            </div>

                            <div class="col-md-3">
                                <label>Least Square Distance:</label>
                                <span data-bind="text:totalLeastSquareDistance"></span>
                            </div>

                        </div>

                        <div class="row">

                            <div class="col-md-3">
                                <label>Number Of Knots</label>
                                <span data-bind="text:numberOfKnots"></span>
                            </div>

                            <div class="col-md-3">
                                <label>Number Of Control Points</label>
                                <span data-bind="text:numberOfControlPoints"></span>
                            </div>

                            <div class="col-md-3">
                                <label>Number Of Data Points</label>
                                <span data-bind="text:numberOfDataPoints"></span>
                            </div>

                            <div class="col-md-3">
                                <label>Number Of Functions</label>
                                <span data-bind="text:numberOfFunctions"></span>
                            </div>

                        </div>

                    </div>

                </div>

            </div>

            <div class="col-md-12">


                <div class="panel panel-danger">

                    <div class="panel-heading" style="font-family: btitr">
                        <h4>Plot Panel</h4>
                    </div>

                    <div class="panel-body" style="text-align: center">


                        <div id="plotly-canvas">

                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="./wwwroot/lib/mathjs/dist/math.js"></script>
    <script src="./wwwroot/lib/knockout/dist/knockout.js"></script>
    <script src="./wwwroot/lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="./wwwroot/lib/plotly.js/dist/plotly.min.js"></script>

    <script src="./wwwroot/js/PlotDrawer.js"></script>
    <script src="./wwwroot/js/BSplinePlotter.js"></script>
    <script src="./wwwroot/js/Point.js"></script>
    <script src="./wwwroot/js/ParameterSelectionMethods.js"></script>
    <script src="./wwwroot/js/BsplineCoxDeboorAlgorithm.js"></script>
    <script src="./wwwroot/js/BasisFunction.js"></script>
    <script src="./wwwroot/js/BSplineLeastSquareApproximation.js"></script>
    <script src="./wwwroot/js/BSplineInterpolation.js"></script>
    <script src="./wwwroot/js/RamerDouglasPeuckerAlgorithm.js"></script>
    <script src="./wwwroot/js/KnotSelectionMethod.js"></script>
    <script src="./wwwroot/js/InputReader.js"></script>

    <script>
        var controlPanelViewModel = {
            spline: ko.observable(1),
            algrothim: ko.observable(),
            order: ko.observable(3),
            fittingMode: ko.observable(2),
            parameterSelection: ko.observable(1),
            knotSelection: ko.observable(1),
            numberOfControlPoints: ko.observable(),
            errorLimit: ko.observable(),
            tolerance: ko.observable(),
            noiseReductionAlgorithm: ko.observable(),
            file: ko.observable(),
            plot:function() {

                /*
                
                var dataPoint = [];    
                for(var i=-15;i<15;i+=0.001){
                    //dataPoint.push(new Point(i,Math.sin(i)));
                    dataPoint.push(new Point(i,Math.sin(i)*i));
                    //dataPoint.push(new Point(i,i*i + 3*i + math.sin(i)));
                }

                plot({dataPoints:dataPoint});*/
                InputReader.read($('#file')[0].files[0], plot);
            }
        }

        var resultViewModel = {
            numberOfKnots: ko.observable(),
            numberOfControlPoints: ko.observable(),
            numberOfDataPoints: ko.observable(),
            minDistance: ko.observable(),
            maxDistance: ko.observable(),
            avgDistance: ko.observable(),
            numberOfFunctions:ko.observable(),
            totalLeastSquareDistance: ko.observable()
        }

        ko.applyBindings(controlPanelViewModel, document.getElementById('controlPanel'));
        ko.applyBindings(resultViewModel, document.getElementById('resultPanel'));

        function plot(jsonInput) {

            var dataPoints = [];

            if(controlPanelViewModel.noiseReductionAlgorithm()==1){

                var ramerDouglasPeuckerAlgorithm = new RamerDouglasPeuckerAlgorithm();
                dataPoints = ramerDouglasPeuckerAlgorithm
                    .compute(jsonInput.dataPoints,controlPanelViewModel.tolerance());

            }
            else{
                dataPoints = jsonInput.dataPoints;
            }

            if (controlPanelViewModel.spline() == 1) {

                if (controlPanelViewModel.fittingMode() == 2) {

                    var approximator = new BSplineLeastSquareApproximation(dataPoints,
                        parseInt(controlPanelViewModel.order()),
                        parseInt(controlPanelViewModel.numberOfControlPoints()) - 1,
                        controlPanelViewModel.parameterSelection(),
                        controlPanelViewModel.knotSelection());

                    var result = approximator.compute();

                    setResultPanel(result);

                    var plotter = new BSplinePlotter(result.cp,
                        result.knots,
                        parseInt(controlPanelViewModel.order()),
                        jsonInput.dataPoints,
                        dataPoints);

                    plotter.plot();

                }
                else if (controlPanelViewModel.fittingMode() == 3) {

                    var interpolator = new BSplineInterpolation(dataPoints,
                        parseInt(controlPanelViewModel.order()),
                        controlPanelViewModel.parameterSelection(),
                        controlPanelViewModel.knotSelection());

                    var result = interpolator.compute();

                    setResultPanel(result);

                    var plotter = new BSplinePlotter(result.cp,
                        result.knots,
                        parseInt(controlPanelViewModel.order()),
                        jsonInput.dataPoints,
                        dataPoints);

                    plotter.plot();

                }

            }

        }

        function setResultPanel(result) {

            resultViewModel.numberOfFunctions(result.knots.length - 2*controlPanelViewModel.order()-1);
            resultViewModel.numberOfDataPoints(result.params.length);
            resultViewModel.numberOfControlPoints(result.cp.length);
            resultViewModel.numberOfKnots ( result.knots.length);

            if(controlPanelViewModel.fittingMode() == 2){
                resultViewModel.minDistance(result.error.minDistance.toFixed(4));
                resultViewModel.maxDistance(result.error.maxDistance.toFixed(4));   
                resultViewModel.avgDistance((result.error.totalDistance / result.params.length).toFixed(4));
                resultViewModel.totalLeastSquareDistance(result.error.totalLeastSquareDistance.toFixed(4));
            }
        
        }

    </script>

</body>

</html>